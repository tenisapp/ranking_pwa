// Replace this line
const corsProxy = 'https://cors.bridged.cc/';

// With this
const corsProxy = 'https://api.allorigins.win/raw?url=';

// Update your fetchRankings function
const fetchRankings = useCallback(async () => {
    setLoadingPlayers(true);
    setPlayerError(null);
    try {
        const fetchPage = (type, page) => {
            const url = `https://${apiHost}/rankings/${type}?page=${page}`;
            return fetch(`${corsProxy}${encodeURIComponent(url)}`, { 
                headers: { 'x-rapidapi-host': apiHost, 'x-rapidapi-key': apiKey } 
            }).then(res => res.json());
        };
        
        // Pobieranie 5 stron z każdego rankingu (5*50=250 graczy z ATP, 250 z WTA)
        const promises = ['wta', 'atp'].flatMap(type => [1, 2, 3, 4, 5].map(page => fetchPage(type, page)));
        const results = await Promise.all(promises);
        const combinedPlayers = results.flatMap(result => (Array.isArray(result.response) ? result.response : []));
        
        // Usuwanie duplikatów, jeśli gracz jest w obu rankingach (np. debel i singiel)
        const uniquePlayers = combinedPlayers
            .sort((a, b) => a.rank - b.rank)
            .filter((player, index, self) => index === self.findIndex(p => p.player.id === player.player.id));
            
        setAllPlayers(uniquePlayers);
    } catch (err) {
        console.error("Błąd API graczy:", err);
        setPlayerError("Nie udało się pobrać rankingu. Spróbuj ponownie później.");
    } finally {
        setLoadingPlayers(false);
    }
}, [corsProxy, apiHost, apiKey]);

// Update your fetchLiveMatches function
const fetchLiveMatches = useCallback(async () => {
    if (allPlayers.length === 0) return;
    setLoadingMatches(true);
    setMatchError(null);
    try {
        const url = `https://${apiHost}/matches/live`;
        const response = await fetch(`${corsProxy}${encodeURIComponent(url)}`, { 
            headers: { 'x-rapidapi-host': apiHost, 'x-rapidapi-key': apiKey } 
        });
        const data = await response.json();
        if (data.errors && Object.keys(data.errors).length > 0) throw new Error(JSON.stringify(data.errors));
        const relevantMatches = data.response.filter(match => {
            const pIds = [match.home.id, match.away.id];
            return pIds.some(id => favorites.includes(id)) || allPlayers.some(p => pIds.includes(p.player.id));
        });
        setLiveMatches(relevantMatches);
    } catch (err) {
        console.error("Błąd API meczów:", err);
        setMatchError("Nie udało się pobrać meczów na żywo. Spróbuj ponownie później.");
    } finally {
        setLoadingMatches(false);
    }
}, [favorites, allPlayers, corsProxy, apiHost, apiKey]);
