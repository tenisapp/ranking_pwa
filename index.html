<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Ustawienia PWA -->
    <title>Ranking Graczy</title>
    <meta name="theme-color" content="#1e293b"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/0ea5e9/ffffff?text=App">

    <!-- Style i Skrypty -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #f1f5f9; }
        .dark body { background-color: #0f172a; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px;
            border-radius: 50%; border-left-color: #0ea5e9;
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Style dla aktywnej zakładki */
        .tab-active { color: #3b82f6; }
        .tab-inactive { color: #64748b; }
        .dark .tab-inactive { color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900">
    <div id="root" class="pb-20"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- DANE ---
        const tournaments = [
            { id: 1, name: 'Australian Open', type: 'Grand Slam', color: 'bg-gradient-to-br from-yellow-400 to-amber-500', textColor: 'text-white', date: '12.01' },
            { id: 10, name: 'Dubai', type: 'WTA/ATP 500', color: 'bg-teal-500', textColor: 'text-white', date: '16.02' },
            { id: 5, name: 'Indian Wells', type: 'ATP 1000', color: 'bg-sky-500', textColor: 'text-white', date: '05.03' },
            { id: 6, name: 'Miami Open', type: 'ATP 1000', color: 'bg-cyan-500', textColor: 'text-white', date: '18.03' },
            { id: 7, name: 'Monte-Carlo', type: 'ATP 1000', color: 'bg-red-500', textColor: 'text-white', date: '06.04' },
            { id: 8, name: 'Madrid Open', type: 'ATP 1000', color: 'bg-orange-500', textColor: 'text-white', date: '22.04' },
            { id: 2, name: 'Roland Garros', type: 'Grand Slam', color: 'bg-gradient-to-br from-yellow-400 to-amber-500', textColor: 'text-white', date: '25.05' },
            { id: 3, name: 'Wimbledon', type: 'Grand Slam', color: 'bg-gradient-to-br from-yellow-400 to-amber-500', textColor: 'text-white', date: '29.06' },
            { id: 11, name: 'Canadian Open', type: 'WTA/ATP 1000', color: 'bg-red-600', textColor: 'text-white', date: '04.08' },
            { id: 9, name: 'Cincinnati', type: 'WTA/ATP 1000', color: 'bg-purple-500', textColor: 'text-white', date: '11.08' },
            { id: 4, name: 'US Open', type: 'Grand Slam', color: 'bg-gradient-to-br from-yellow-400 to-amber-500', textColor: 'text-white', date: '25.08' },
            { id: 12, name: 'Shanghai', type: 'ATP 1000', color: 'bg-blue-700', textColor: 'text-white', date: '02.10' },
            { id: 13, name: 'Paris', type: 'ATP 1000', color: 'bg-indigo-600', textColor: 'text-white', date: '28.10' },
            { id: 15, name: 'WTA Finals', type: 'Finals', color: 'bg-violet-700', textColor: 'text-white', date: '02.11' },
            { id: 14, name: 'ATP Finals', type: 'Finals', color: 'bg-red-800', textColor: 'text-white', date: '09.11' },
        ];

        // --- CUSTOM HOOKS ---
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.error(error);
                }
            };
            return [storedValue, setValue];
        };

        // --- KOMPONENTY ---
        const TournamentPill = ({ tournament }) => (
            <div className={`flex-shrink-0 px-4 py-2 rounded-full shadow-md cursor-pointer transition-transform transform hover:scale-105 ${tournament.color}`}>
                <div className="flex items-center space-x-2">
                    <span className={`font-semibold text-sm ${tournament.textColor}`}>{tournament.name}</span>
                    <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${tournament.textColor} bg-white/20`}>{tournament.date}</span>
                </div>
            </div>
        );

        const PlayerCard = ({ player, isFavorite, onToggleFavorite }) => {
            const id = player.player.id;
            const { name, photo } = player.player;
            const { rank, points } = player;
            
            return (
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-lg overflow-hidden">
                    <div className="p-5">
                        <div className="flex items-start space-x-4">
                            <img className="w-20 h-20 rounded-full border-4 border-slate-200 dark:border-slate-700 object-cover" src={photo || `https://placehold.co/100x100/e2e8f0/64748b?text=${name.charAt(0)}`} alt={`Zdjęcie ${name}`} />
                            <div className="flex-1">
                                <div className="flex justify-between items-center">
                                    <p className="text-sm font-bold text-blue-500 dark:text-blue-400">RANKING: {rank}</p>
                                    <img src={`https://flagcdn.com/w40/pl.png`} alt="Flaga Polski" className="w-7 rounded-sm" />
                                </div>
                                <h3 className="mt-1 text-xl font-bold text-slate-800 dark:text-slate-100">{name}</h3>
                            </div>
                        </div>
                        <div className="mt-4 bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4 flex justify-between items-center">
                            <div className="text-center">
                                <p className="text-xs font-medium text-slate-500 dark:text-slate-400">PUNKTY</p>
                                <p className="text-lg font-bold text-slate-900 dark:text-white">{points ? points.toLocaleString('pl-PL') : 'B/D'}</p>
                            </div>
                            <button onClick={() => onToggleFavorite(id)} className="text-3xl transition-colors duration-200">
                                <i className={`${isFavorite ? 'fa-solid text-yellow-400' : 'fa-regular'} fa-star`}></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LiveMatchCard = ({ match }) => {
            const { home, away, scores } = match;
            return (
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-4">
                    <p className="text-xs text-center text-slate-500 dark:text-slate-400 mb-2">{match.league.name} - {match.status.long}</p>
                    <div className="grid grid-cols-3 items-center text-slate-800 dark:text-slate-100">
                        <div className="text-left"><p className="font-bold truncate">{home.name}</p></div>
                        <div className="text-center font-mono text-xl font-extrabold"><span>{scores.home.display}</span> - <span>{scores.away.display}</span></div>
                        <div className="text-right"><p className="font-bold truncate">{away.name}</p></div>
                    </div>
                </div>
            );
        };

        const LoadingIndicator = ({ text }) => (
            <div className="flex flex-col items-center justify-center p-10"><div className="spinner"></div><p className="mt-4 text-slate-600 dark:text-slate-300 font-semibold">{text}</p></div>
        );

        const EmptyState = ({ icon, text }) => (
             <div className="text-center py-16 px-6 bg-white dark:bg-slate-800 rounded-xl shadow-md"><i className={`fa-solid ${icon} text-4xl text-slate-300 dark:text-slate-600 mb-4`}></i><p className="text-slate-500 dark:text-slate-400">{text}</p></div>
        );

        const SettingsView = ({ favoritePlayers, notificationSettings, setNotificationSettings }) => {
            const [permissionStatus, setPermissionStatus] = useState(Notification.permission);

            const requestNotificationPermission = () => {
                Notification.requestPermission().then(status => {
                    setPermissionStatus(status);
                });
            };

            const handleSettingChange = (playerId, newSetting) => {
                setNotificationSettings(prev => ({ ...prev, [playerId]: { ...(prev[playerId] || {}), ...newSetting } }));
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-5">
                        <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100 mb-2">Zgoda na powiadomienia</h2>
                        {permissionStatus === 'granted' && <p className="text-sm text-green-600 dark:text-green-400">Powiadomienia są włączone.</p>}
                        {permissionStatus === 'denied' && <p className="text-sm text-red-600 dark:text-red-400">Odmówiono zgody na powiadomienia. Zmień to w ustawieniach przeglądarki.</p>}
                        {permissionStatus === 'default' && (
                            <>
                                <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">Aby otrzymywać alerty o meczach, musisz zezwolić na powiadomienia.</p>
                                <button onClick={requestNotificationPermission} className="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Włącz powiadomienia</button>
                            </>
                        )}
                    </div>

                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-5">
                        <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100 mb-4">Ustawienia alertów</h2>
                        {favoritePlayers.length === 0 ? (
                            <p className="text-sm text-slate-500 dark:text-slate-400">Dodaj graczy do ulubionych, aby skonfigurować dla nich powiadomienia.</p>
                        ) : (
                            <div className="space-y-4">
                                {favoritePlayers.map(player => {
                                    const settings = notificationSettings[player.player.id] || { enabled: false, time: 15 };
                                    return (
                                        <div key={player.player.id} className="border-t border-slate-200 dark:border-slate-700 pt-4 first:border-t-0 first:pt-0">
                                            <div className="flex justify-between items-center">
                                                <span className="font-medium text-slate-800 dark:text-slate-200">{player.player.name}</span>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" checked={settings.enabled} onChange={e => handleSettingChange(player.player.id, { enabled: e.target.checked })} className="sr-only peer" />
                                                    <div className="w-11 h-6 bg-slate-200 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                </label>
                                            </div>
                                            {settings.enabled && (
                                                <div className="mt-3">
                                                    <label className="block text-sm text-slate-600 dark:text-slate-300 mb-2">Powiadom <span className="font-bold text-blue-500">{settings.time} min</span> przed meczem</label>
                                                    <input type="range" min="5" max="30" step="5" value={settings.time} onChange={e => handleSettingChange(player.player.id, { time: parseInt(e.target.value) })}
                                                        className="w-full h-2 bg-slate-200 dark:bg-slate-600 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                                </div>
                                            )}
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- GŁÓWNA APLIKACJA ---
        function App() {
            const [activeTab, setActiveTab] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [isNightShift, setIsNightShift] = useState(false);
            
            const [allPlayers, setAllPlayers] = useState([]);
            const [loadingPlayers, setLoadingPlayers] = useState(true);
            const [playerError, setPlayerError] = useState(null);

            const [liveMatches, setLiveMatches] = useState([]);
            const [loadingMatches, setLoadingMatches] = useState(true);
            const [matchError, setMatchError] = useState(null);

            const [favorites, setFavorites] = useLocalStorage('favoritePlayers', []);
            const [notificationSettings, setNotificationSettings] = useLocalStorage('notificationSettings', {});

            const apiKey = 'M6kb7mfgOmk841o3ttWGMSaSx9YeeYuX5A1CJlVd';
            const apiHost = 'v1.tennis.api-sports.io';
            const corsProxy = 'https://thingproxy.freeboard.io/fetch/';

            const toggleFavorite = (playerId) => {
                setFavorites(prev => 
                    prev.includes(playerId)
                        ? prev.filter(id => id !== playerId)
                        : [...prev, playerId]
                );
            };

            const fetchRankings = useCallback(async () => {
                setLoadingPlayers(true);
                setPlayerError(null);
                try {
                    const fetchPage = (type, page) => fetch(`${corsProxy}https://${apiHost}/rankings/${type}?page=${page}`, { headers: { 'x-rapidapi-host': apiHost, 'x-rapidapi-key': apiKey } }).then(res => res.json());
                    const promises = ['wta', 'atp'].flatMap(type => [1, 2].map(page => fetchPage(type, page)));
                    const results = await Promise.all(promises);
                    const combinedPlayers = results.flatMap(result => (Array.isArray(result.response) ? result.response : []));
                    const uniquePlayers = combinedPlayers.filter(p => p.player.country === 'Poland').sort((a, b) => a.rank - b.rank).filter((p, i, self) => i === self.findIndex(o => o.player.id === p.player.id));
                    setAllPlayers(uniquePlayers);
                } catch (err) {
                    console.error("Błąd API graczy:", err);
                    setPlayerError("Nie udało się pobrać rankingu.");
                } finally {
                    setLoadingPlayers(false);
                }
            }, []);

            const fetchLiveMatches = useCallback(async () => {
                if (allPlayers.length === 0) return;
                setLoadingMatches(true);
                setMatchError(null);
                try {
                    const response = await fetch(`${corsProxy}https://${apiHost}/matches/live`, { headers: { 'x-rapidapi-host': apiHost, 'x-rapidapi-key': apiKey } });
                    const data = await response.json();
                    if (data.errors && Object.keys(data.errors).length > 0) throw new Error(JSON.stringify(data.errors));
                    const relevantMatches = data.response.filter(match => {
                        const pIds = [match.home.id, match.away.id];
                        return pIds.some(id => favorites.includes(id)) || allPlayers.some(p => pIds.includes(p.player.id));
                    });
                    setLiveMatches(relevantMatches);
                } catch (err) {
                    console.error("Błąd API meczów:", err);
                    setMatchError("Nie udało się pobrać meczów na żywo.");
                } finally {
                    setLoadingMatches(false);
                }
            }, [favorites, allPlayers]);

            useEffect(() => { document.documentElement.classList.toggle('dark', isNightShift); }, [isNightShift]);
            useEffect(() => { fetchRankings(); }, [fetchRankings]);
            useEffect(() => { if (activeTab === 'live') fetchLiveMatches(); }, [activeTab, fetchLiveMatches]);
            
            const filteredPlayers = useMemo(() => allPlayers.filter(p => p.player.name.toLowerCase().includes(searchTerm.toLowerCase())), [allPlayers, searchTerm]);
            const favoritePlayers = useMemo(() => allPlayers.filter(p => favorites.includes(p.player.id)), [allPlayers, favorites]);

            return (
                <>
                    <div className="max-w-4xl mx-auto p-4">
                        <header className="flex justify-between items-center mb-4">
                            <h1 className="text-3xl font-extrabold text-slate-800 dark:text-white tracking-tight">Ranking</h1>
                             <div className="flex items-center space-x-2">
                                <i className="fa-solid fa-sun text-yellow-500"></i>
                                <label htmlFor="night-shift-toggle" className="relative inline-flex items-center cursor-pointer">
                                  <input type="checkbox" id="night-shift-toggle" className="sr-only peer" checked={isNightShift} onChange={() => setIsNightShift(!isNightShift)} />
                                  <div className="w-11 h-6 bg-slate-200 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                                <i className="fa-solid fa-moon text-slate-400"></i>
                             </div>
                        </header>

                        {activeTab === 'all' && (
                            <>
                                <div className="mb-6"><div className="flex space-x-3 overflow-x-auto pb-4 no-scrollbar">{tournaments.map(t => <TournamentPill key={t.id} tournament={t} />)}</div></div>
                                <div className="relative mb-6">
                                    <input type="text" placeholder="Szukaj gracza..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                                        className="w-full pl-12 pr-4 py-3 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-xl shadow-md" />
                                    <i className="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                </div>
                            </>
                        )}
                        
                        <main className="space-y-5">
                            {activeTab === 'all' && (
                                loadingPlayers ? <LoadingIndicator text="Pobieranie rankingu..." /> :
                                playerError ? <EmptyState icon="fa-cloud-exclamation" text={playerError} /> :
                                filteredPlayers.length > 0 ? filteredPlayers.map(p => <PlayerCard key={p.player.id} player={p} isFavorite={favorites.includes(p.player.id)} onToggleFavorite={toggleFavorite} />) :
                                <EmptyState icon="fa-user-slash" text="Nie znaleziono graczy." />
                            )}
                            {activeTab === 'favorites' && (
                                loadingPlayers ? <LoadingIndicator text="Ładowanie ulubionych..." /> :
                                favoritePlayers.length > 0 ? favoritePlayers.map(p => <PlayerCard key={p.player.id} player={p} isFavorite={true} onToggleFavorite={toggleFavorite} />) :
                                <EmptyState icon="fa-star" text="Nie masz jeszcze ulubionych graczy." />
                            )}
                            {activeTab === 'live' && (
                                <>
                                    <button onClick={fetchLiveMatches} disabled={loadingMatches} className="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 disabled:bg-slate-400">
                                        <i className={`fa-solid fa-rotate ${loadingMatches ? 'animate-spin' : ''}`}></i>{loadingMatches ? 'Odświeżanie...' : 'Odśwież mecze'}</button>
                                    {loadingMatches ? <LoadingIndicator text="Szukanie meczów na żywo..." /> :
                                    matchError ? <EmptyState icon="fa-satellite-dish" text={matchError} /> :
                                    liveMatches.length > 0 ? liveMatches.map(m => <LiveMatchCard key={m.id} match={m} />) :
                                    <EmptyState icon="fa-bed" text="Brak meczów na żywo." />}
                                </>
                            )}
                            {activeTab === 'settings' && (
                                <SettingsView favoritePlayers={favoritePlayers} notificationSettings={notificationSettings} setNotificationSettings={setNotificationSettings} />
                            )}
                        </main>
                    </div>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-t border-slate-200 dark:border-slate-700">
                        <div className="max-w-4xl mx-auto flex justify-around">
                            <button onClick={() => setActiveTab('all')} className={`flex-1 py-3 text-center transition-colors ${activeTab === 'all' ? 'tab-active' : 'tab-inactive'}`}>
                                <i className="fa-solid fa-users text-xl"></i><span className="block text-xs font-medium">Wszyscy</span></button>
                            <button onClick={() => setActiveTab('favorites')} className={`flex-1 py-3 text-center transition-colors ${activeTab === 'favorites' ? 'tab-active' : 'tab-inactive'}`}>
                                <i className="fa-solid fa-star text-xl"></i><span className="block text-xs font-medium">Ulubieni</span></button>
                            <button onClick={() => setActiveTab('live')} className={`flex-1 py-3 text-center transition-colors ${activeTab === 'live' ? 'tab-active' : 'tab-inactive'}`}>
                                <i className="fa-solid fa-tower-broadcast text-xl"></i><span className="block text-xs font-medium">Na żywo</span></button>
                            <button onClick={() => setActiveTab('settings')} className={`flex-1 py-3 text-center transition-colors ${activeTab === 'settings' ? 'tab-active' : 'tab-inactive'}`}>
                                <i className="fa-solid fa-gear text-xl"></i><span className="block text-xs font-medium">Ustawienia</span></button>
                        </div>
                    </nav>
                </>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
    
    <script>
        const manifest = { "name": "Ranking Graczy PWA", "short_name": "Ranking", "start_url": ".", "display": "standalone", "background_color": "#0f172a", "theme_color": "#1e293b", "description": "Aplikacja do śledzenia rankingu ulubionych graczy.", "icons": [ { "src": "https://placehold.co/192x192/0ea5e9/ffffff?text=App", "type": "image/png", "sizes": "192x192" }, { "src": "https://placehold.co/512x512/0ea5e9/ffffff?text=App", "type": "image/png", "sizes": "512x512" } ] };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);

        const swCode = `
            self.addEventListener('install', event => {
                console.log('Service Worker instalowany.');
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    fetch(event.request).catch(() => caches.match(event.request))
                );
            });

            self.addEventListener('push', function(event) {
                const data = event.data ? event.data.json() : { title: 'Błąd', body: 'Brak danych powiadomienia' };
                const title = data.title;
                const options = {
                    body: data.body,
                    icon: 'https://placehold.co/192x192/0ea5e9/ffffff?text=App',
                    badge: 'https://placehold.co/96x96/0ea5e9/ffffff?text=!',
                };
                event.waitUntil(self.registration.showNotification(title, options));
            });
        `;
        const swBlob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(swBlob);
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('ServiceWorker zarejestrowany:', reg.scope))
                    .catch(err => console.log('Błąd rejestracji ServiceWorkera:', err));
            });
        }
    </script>
</body>
</html>
